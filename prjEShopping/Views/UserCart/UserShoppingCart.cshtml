@model List<prjEShopping.Models.ViewModels.UserShoppingCartVM>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
    //購物車
}


<div class="bg-light">
    <div class="container pt-2">
        <p class="text-primary fs-3 fw-bold">購物車</p>
        <div class="row bg-success rounded py-3 mb-3">
            <div class="col-1">
                <input type="checkbox" class="form-check-input">
            </div>
            <div class="col-3">
                <span>商品</span>
            </div>
            <div class="col-2">
                <span>單價</span>
            </div>
            <div class="col-2">
                <span>數量</span>
            </div>
            <div class="col-2">
                <span>總計</span>
            </div>
            <div class="col-2">
                <span>操作</span>
            </div>
        </div>

        <div class="row bg-success rounded py-3 mb-3">
            <div class="row mb-3">
                <div class="col-1 d-flex align-items-center">
                    <input type="checkbox" class="form-check-input">
                </div>
                <div class="col-3 d-flex align-items-center">
                    <span>賣家名稱</span>
                </div>
                <div class="col-2 d-flex align-items-center">
                    <button class="btn btn-blue">聊聊</button>
                </div>
            </div>
            @foreach (var item in Model)
            {
                <div class="row">
                    <div class="col-1">
                        <input type="checkbox" class="form-check-input">
                    </div>
                    <div class="col-3">
                        <div class="mb-3" style="max-width: 540px;">
                            <div class="row g-0">
                                <div class="col-md-4">
                                    <img src="~/img/@Html.DisplayFor(modelItem => item.ProductImagePathOne)" class="img-fluid rounded-start" alt="...">
                                </div>
                                <div class="col-md-8">
                                    <div class="card-body">
                                        <p class="card-text">@item.ProductName</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-2 d-flex align-items-center">
                        <span>@Math.Round(item.Price).ToString("C0")</span>
                    </div>
                    <div class="col-2 d-flex align-items-center">
                        <div class="input-group" style="width: 120px;">
                            @*加減數量*@
                            <button class="btn btn-outline-primary minusBtn" type="button" data-id="@item.ProductId" data-qty="@item.Quantity" data-stockqty="@item.ProductStock">-</button>
                            <input type="text" class="form-control" id="quantityInput" readonly value="@item.Quantity">
                            <button class="btn btn-outline-primary plusBtn" type="button" data-id="@item.ProductId" data-qty="@item.Quantity" data-stockqty="@item.ProductStock">+</button>
                        </div>
                    </div>
                    <div class="col-2 d-flex align-items-center">
                        @*<span class="text-danger fw-bold">$@string.Format("{0:n0}", Math.Round((decimal)item.SubTotal))</span>*@
                        <span class="text-danger fw-bold">@Math.Round(item.SubTotal).ToString("C0")</span>
                    </div>
                    <div class="col-2 d-flex align-items-center">
                        <button class="btn btn-danger delete2cart" data-id="@item.ProductId">刪除</button>
                        <span hidden data-cartid="@item.CartId" id="cartid"></span>@*為了獲得購物車編號*@
                    </div>
                </div>
            }
        </div>



        <!-- 結帳 -->
        <div class="row bg-success rounded py-3">
            <div class="row mb-3">
                <div class="col-1 d-flex align-items-center">
                    <input type="checkbox" class="form-check-input">
                </div>
                <div class="col-3 d-flex align-items-center">
                    <span>全選</span>
                    <span class="text-danger fw-bold">(</span>
                    <span class="text-danger fw-bold totalItemCount"></span>
                    <span class="text-danger fw-bold">)</span>
                </div>

                <div class="col-4 d-flex align-items-center">
                    <span>總金額(</span>
                    <span class="text-danger fw-bold totalItemCount"></span>
                    <span>個商品)：</span>
                </div>
                <div class="col-2 d-flex align-items-center">
                    <span class="text-danger fw-bold fs-4"> @Math.Round(ViewBag.TotalPrice).ToString("C0")</span>
                </div>
                <div class="col-2 d-flex align-items-center">
                    @*<a id="checkoutLink" href="@Url.Content("~/UserCart/UserCheckout")" class="btn btn-secondary flex-grow-1 btn-lg">去買單</a>*@
                    <a class="btn btn-secondary flex-grow-1 btn-lg" id="checkoutLink">去買單</a>
                </div>
            </div>
        </div>
    </div>
</div>


@*去買單跳出視窗是否有商品*@
<div class="modal" id="checkCartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                購物車中沒有商品，無法前往結帳。
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="confirmButton">確定</button>
            </div>
        </div>
    </div>
</div>


@*去買單跳出視窗是否有商品*@
<div class="modal" id="deleteCartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                確定要從購物車刪除此商品嗎？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="confirmButton2delete">確定</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="cancelButton2delete">取消</button>
            </div>
        </div>
    </div>
</div>


@*庫存不足*@
<div class="modal" id="stockCartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                庫存不足，請選購其他商品。
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="confirmButtonstock">確定</button>
            </div>
        </div>
    </div>
</div>

@*有商品數量庫存不足無法結帳*@
<div class="modal" id="stockCartcheckModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                購物車內有商品庫存不足，無法進入結帳，請先刪除商品數量為0商品。
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="confirmButtonstockcheck">確定</button>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script>

        //刪除購物車的商品
        $(document).ready(function () {
            $(".delete2cart").each(function () {
                $(this).on('click', async function () {
                    var self = $(this);
                    var ProductId = self.attr("data-id");
                    //console.log(ProductId)

                    $("#deleteCartModal").modal("show");

                    $("#confirmButton2delete").on('click', async function () {
                        //按下確認才呼叫刪除購物車商品的api
                        const result = await $.get("/UserCart/UserDeleteCartapi?ProductId=" + ProductId)
                        const result2 = await $.get("/UserCart/UserUpadateCartStockapi?ProductId=" + ProductId)
                        // 成功刪除後重新載入頁面
                        location.reload();
                    })

                    $("#cancelButton2delete").on('click', async function () {
                        //不做動作
                    })
                })
            })
        })



        //更新購物車商品數量
        $(document).ready(function () {
            $(".plusBtn").each(function () {
                $(this).on('click', async function () {
                    var self = $(this);

                    var ProductId = self.attr("data-id");
                    var Quantity = parseInt(self.attr("data-qty")) + 1;
                    var Productstock = self.attr("data-stockqty");

                    if (Productstock > 0) {
                        const result = await $.get("/UserCart/UserUpadateCartapi?ProductId=" + ProductId + "&Quantity=" + Quantity)
                        const result2 = await $.get("/UserCart/UserUpadateCartStockapi?ProductId=" + ProductId)
                        location.reload();
                    } else {
                        //alert("庫存不足")
                        $("#stockCartModal").modal("show");
                        $("#confirmButtonstock").on('click', () => {
                            location.reload();
                        })
                    }
                })
            })

            $(".minusBtn").each(function () {
                $(this).on('click', async function () {
                    var self = $(this);

                    var ProductId = self.attr("data-id")

                    var Quantity = parseInt(self.attr("data-qty")) - 1;

                    if (Quantity == 0) {
                        const result = await $.get("/UserCart/UserDeleteCartapi?ProductId=" + ProductId);//Quantity=0呼叫刪除api
                        const result2 = await $.get("/UserCart/UserUpadateCartStockapi?ProductId=" + ProductId)
                        location.reload();
                    } else {
                        const result = await $.get("/UserCart/UserUpadateCartapi?ProductId=" + ProductId + "&Quantity=" + Quantity);
                        const result2 = await $.get("/UserCart/UserUpadateCartStockapi?ProductId=" + ProductId)
                        location.reload();
                    }
                })
            })
        })


        //按下去買單要在檢核一次現在的訂單量
        $(document).ready(function () {
            $("#checkoutLink").each(function () {
                $(this).on('click', async function () {
                    var cartid = document.querySelector("#cartid").getAttribute("data-cartid");
                    var qua = 0;
                    //console.log(cartid)
                    
                    if (qua > 0) {//要改
                        window.location.href = "/UserCart/UserCheckout";
                    } else {
                        $("#stockCartcheckModal").modal("show")
                        $("#confirmButtonstockcheck").on('click', async function () {
                            const result = await$.get("/UserCart/UserCartCheckStockapi?cartid=" + cartid)
                        })
                    }
                })
            })
        })


    </script>
}

