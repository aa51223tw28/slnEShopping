@*這是list*@
@model IEnumerable<prjEShopping.Models.DTOs.UserProductIndexDto>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
    //篩選頁面
}

<div class="bg-light">

    <!-- 左邊篩選器 -->
    <div class="container py-3">
        <div class="row py-2">
            <div class="col-3 d-flex flex-column">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <i class="fa-solid fa-bars"></i>
                        <span class="ms-2">所有分類</span>
                    </div>
                    <button class="btn btn-secondary mt-2" id="isSelected">搜尋</button>
                </div>
                <div class="fs-5">
                    <i class="fa-solid fa-caret-down"></i><span class="text-blue fw-bold">3C資訊</span>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected101">
                    <label class="form-check-label">
                        筆電
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected102">
                    <label class="form-check-label">
                        桌機
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected103">
                    <label class="form-check-label">
                        螢幕
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected104">
                    <label class="form-check-label">
                        鍵盤
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected105">
                    <label class="form-check-label">
                        滑鼠
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected106">
                    <label class="form-check-label">
                        儲存硬碟
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected107">
                    <label class="form-check-label">
                        耳機
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected108">
                    <label class="form-check-label">
                        音響
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected109">
                    <label class="form-check-label">
                        藍芽穿戴
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected110">
                    <label class="form-check-label">
                        印表機
                    </label>
                </div>
                <div class="fs-5">
                    <i class="fa-solid fa-caret-down"></i><span class="text-blue fw-bold">數位通訊</span>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected201">
                    <label class="form-check-label">
                        手機
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected202">
                    <label class="form-check-label">
                        平板
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected203">
                    <label class="form-check-label">
                        相機
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected204">
                    <label class="form-check-label">
                        遊戲主機
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected205">
                    <label class="form-check-label">
                        光碟片
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected206">
                    <label class="form-check-label">
                        充電線
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected207">
                    <label class="form-check-label">
                        轉接頭
                    </label>
                </div>
                <div class="fs-5">
                    <i class="fa-solid fa-caret-down"></i><span class="text-blue fw-bold">生活家電</span>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected301">
                    <label class="form-check-label">
                        冰箱
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected302">
                    <label class="form-check-label">
                        洗衣機
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected303">
                    <label class="form-check-label">
                        乾衣機
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected304">
                    <label class="form-check-label">
                        電風扇
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected305">
                    <label class="form-check-label">
                        冷氣
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected306">
                    <label class="form-check-label">
                        烤箱
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected307">
                    <label class="form-check-label">
                        微波爐
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected308">
                    <label class="form-check-label">
                        電子鍋
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected309">
                    <label class="form-check-label">
                        吸塵器
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected310">
                    <label class="form-check-label">
                        電動牙刷
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isSubcategorySelected311">
                    <label class="form-check-label">
                        電鬍刀
                    </label>
                </div>
                <hr>
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-bars"></i><span class="ms-2">品牌</span>
                </div>

                @*也是品牌傳過來一堆products裡面的BrandName在前端移除重複*@
                @*@{
                        var uniqueBrandNames = new HashSet<string>();
                    }

                    @foreach (var item in Model)
                    {
                        if (!uniqueBrandNames.Contains(item.BrandName))
                        {
                            uniqueBrandNames.Add(item.BrandName);
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="isBrand@(item.BrandId)">
                                <label class="form-check-label">
                                    @item.BrandName
                                </label>
                            </div>
                        }
                    }*@


                @*用ViewBag直接將table傳過來item.出table的欄位*@
                @foreach (var item in ViewBag.Brand)
                {
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="isBrandSelected@(item.BrandId)">
                        <label class="form-check-label">
                            @item.BrandName
                        </label>
                    </div>
                }



                <hr>
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-bars"></i><span class="ms-2">價格範圍</span>
                </div>
                <div class="d-flex">
                    <input type="text" class="form-control" placeholder="NT$最小值" aria-label="Username" aria-describedby="basic-addon1" id="pricelow">
                    <span class="pt-3">―――</span>
                    <input type="text" class="form-control" placeholder="NT$最大值" aria-label="Username" aria-describedby="basic-addon1" id="pricehigh">
                </div>

                <hr>
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-bars"></i><span class="ms-2">評價</span>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="">
                    <label class="form-check-label">
                        <i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-solid fa-star" style="color: #ffe180;"></i>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="">
                    <label class="form-check-label">
                        <i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-regular fa-star" style="color: #ffe180;"></i>或以上
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="">
                    <label class="form-check-label">
                        <i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-regular fa-star" style="color: #ffe180;"></i><i class="fa-regular fa-star" style="color: #ffe180;"></i>或以上
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="">
                    <label class="form-check-label">
                        <i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-regular fa-star" style="color: #ffe180;"></i><i class="fa-regular fa-star" style="color: #ffe180;"></i><i class="fa-regular fa-star" style="color: #ffe180;"></i>或以上
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="">
                    <label class="form-check-label">
                        <i class="fa-solid fa-star" style="color: #ffe180;"></i><i class="fa-regular fa-star" style="color: #ffe180;"></i><i class="fa-regular fa-star" style="color: #ffe180;"></i><i class="fa-regular fa-star" style="color: #ffe180;"></i><i class="fa-regular fa-star" style="color: #ffe180;"></i>或以上
                    </label>
                </div>






            </div>

            <!-- 右邊內容 -->
            <div class="col-9">
                <div class="row">
                    <div class="col-9">
                        <div class="p-3 d-flex align-items-center gap-3">
                            <span>篩選</span>
                            <button type="button" class="btn btn-outline-blue" id="btnAll">全部</button>
                            <button type="button" class="btn btn-outline-blue" id="btnHot">最熱銷</button>
                            <button type="button" class="btn btn-outline-blue" id="btnPriceHight">價格：高到低</button>
                            <button type="button" class="btn btn-outline-blue" id="btnPriceLow">價格：低到高</button>
                            <button type="button" class="btn btn-outline-danger" id="btnDelete">清除篩選</button>
                        </div>
                    </div>
                    <div class="col-3">
                        <span>頁碼：</span>
                        <div class="d-flex" id="paginationContainer">
                            <!-- 分頁標籤將動態生成並放入這裡 -->
                        </div>

                        <!-- 分頁標籤 -->
                        @*<nav aria-label="Page navigation example ">
                                <ul class="pagination justify-content-center mt-3">
                                    <li class="page-item">
                                        <a class="page-link" href="#" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item">
                                        <a class="page-link" href="#" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>*@
                    </div>

                </div>

                <!-- 商品開始 -->
                <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3 mt-2" id="productContainer">

                    @foreach (var item in Model)
                    {
                        <div class="col">
                            <div class="card w-100">
                                <img src="~/img/@Html.DisplayFor(modelItem => item.ProductImagePathOne)" class="card-img-top px-4 pt-4" alt="...">
                                <div class="card-body">
                                    <p class="card-title">@Html.DisplayFor(modelItem => item.ProductName)</p>

                                    <span class="card-text text-danger fw-bold mb-1">@Math.Round(item.Price).ToString("C0")</span>
                                    <p style="font-size: 8px;" class="card-text mb-1">已售出：@(item.QuantitySold)</p>

                                    <a href="@Url.Action("UserSingleProduct", "UserProduct", new {productid=item.ProductId})" class="btn btn-secondary">了解更多...</a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <!-- 商品結束 -->


            </div>
        </div>
    </div>
</div>


@section Scripts{
    <script>

        //篩選條件-全部 最熱銷 價格高到低 低到高
        $(document).ready(function() {
            var products = @Html.Raw(Json.Encode(Model)); // 將 Model 序列化為 JSON 字串
            $("#btnAll").css({ "background-color": "#0D47A1", "color": "white" })//預設樣式被點選

            //主頁直接點筆電篩選條件載入頁面如有subcategoryid
            var urlParams = new URLSearchParams(window.location.search);//得當前網頁 URL 中的查詢參數部分
            var subcategoryParam = urlParams.get('subcategory');
            if (subcategoryParam) {
                var selectedsubcategoryId = parseInt(subcategoryParam)
                products = products.filter(function (product) {
                    return product.SubcategoryId === selectedsubcategoryId;
                });
                $("#isSubcategorySelected" + selectedsubcategoryId).prop("checked", true)
            }
            updateProductContainer();



            // 定義所有的分類編碼
            var subcategoryIds = [
                101, 102, 103, 104, 105, 106, 107, 108, 109, 110,
                201, 202, 203, 204, 205, 206, 207,
                301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311
            ];


            //定義所有品牌編碼
            var brandIds = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14];

            function filterSelected() {
                var selectedSubcategories = [];
                var selectedBrands = [];

                // 循環通過所有可能的 SubcategoryId
                subcategoryIds.forEach(function (subcategoryId) {
                    if ($("#isSubcategorySelected" + subcategoryId).prop("checked")) {
                        selectedSubcategories.push(subcategoryId);
                        //console.log(subcategoryId)
                    }
                });
                //console.log(selectedSubcategories)
                // 循環通過所有可能的品牌編碼
                brandIds.forEach(function (brandId) {
                    if ($("#isBrandSelected" + brandId).prop("checked")) {
                        selectedBrands.push(brandId);
                    }
                });

                var minPrice = parseFloat($("#pricelow").val());
                var maxPrice = parseFloat($("#pricehigh").val());

                // 如果沒有選中任何 SubcategoryId 和品牌，則返回所有產品
                if (selectedSubcategories.length === 0 && selectedBrands.length === 0 && isNaN(minPrice) && isNaN(maxPrice)) {
                    return products;
                }

                // 篩選符合條件的產品               
                return products.filter(function (product) {
                    var subcategoryMatch = selectedSubcategories.length === 0 || selectedSubcategories.includes(product.SubcategoryId);
                    var brandMatch = selectedBrands.length === 0 || selectedBrands.includes(product.BrandId);
                    var priceMatch = (isNaN(minPrice) && isNaN(maxPrice)) || (product.Price >= minPrice && product.Price <= maxPrice) || (product.Price >= minPrice && isNaN(maxPrice) || (isNaN(minPrice) && product.Price <= maxPrice));

                    return subcategoryMatch && brandMatch && priceMatch;

                });


            }

           

            //按下搜尋
            $("#isSelected").on('click', function () {
                products = @Html.Raw(Json.Encode(Model));
                products = filterSelected();
                updateProductContainer();
            });

            //按下清除設定
            $("#btnDelete").on('click', async function () {
                var urlParams = new URLSearchParams(window.location.search);
                urlParams.delete('category');
                var updatedQueryString = urlParams.toString();
                window.location.href = window.location.pathname + '?' + updatedQueryString;
            });


            //按下全部
            $("#btnAll").on('click', async function () {
                $(this).css({ "background-color": "#0D47A1", "color": "white" })
                $("#btnHot,#btnPriceHight,#btnPriceLow").css({ "background-color": "transparent", "color": "#0D47A1", "border": "1px solid #0D47A1" })

                handlePageClick(1);

            });


            // 按下按鈕 "最熱銷"
            $("#btnHot").click(function () {
                $(this).css({ "background-color": "#0D47A1", "color": "white" })
                $("#btnAll,#btnPriceHight,#btnPriceLow").css({ "background-color": "transparent", "color": "#0D47A1", "border": "1px solid #0D47A1" })
                currentSortType = "hot";
                handlePageClick(1);
            });

            //按下價格高到低
            $("#btnPriceHight").click(function () {
                $(this).css({ "background-color": "#0D47A1", "color": "white" })
                $("#btnAll,#btnHot,#btnPriceLow").css({ "background-color": "transparent", "color": "#0D47A1", "border": "1px solid #0D47A1" })

                currentSortType = "price_high";
                handlePageClick(1);
            });

            // 按下價格低到高
            $("#btnPriceLow").click(function () {
                $(this).css({ "background-color": "#0D47A1", "color": "white" })
                $("#btnAll,#btnHot,#btnPriceHight").css({ "background-color": "transparent", "color": "#0D47A1", "border": "1px solid #0D47A1" })

                currentSortType = "price_low";
                handlePageClick(1);
            });

            // 重新生成商品迴圈內容的函式
            function updateProductContainer() {
                var container = $("#productContainer");
                container.empty();

                if (products.length === 0) {
                    var noProductMessage = `<div class="col text-center">本篩選下無符合商品</div>`;
                    container.append(noProductMessage);
                } else {
                    $.each(products, function(index, item) {
                        var productCard = `
                            <div class="col">
                                <div class="card w-100">
                                    <img src="/img/${item.ProductImagePathOne}" class="card-img-top px-4 pt-4" alt="...">
                                    <div class="card-body">
                                        <p class="card-title">${item.ProductName}</p>
                                        <span class="card-text text-danger fw-bold">NT$${Math.round(item.Price).toLocaleString()}</span>
                                        <p style="font-size: 8px;" class="card-text mb-1">已售出：${item.QuantitySold}</p>
                                        <a href="@Url.Action("UserSingleProduct", "UserProduct")?productid=${item.ProductId}" class="btn btn-secondary">了解更多...</a>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.append(productCard);
                    });
                }
            }



           // 動態生成分頁標籤
            showPage(1, products);

            var pageSize = 20;
            var totalPages = Math.ceil(products.length / pageSize);

            var paginationContainer = document.getElementById("paginationContainer");
            var paginationHTML = "";
            for (var i = 1; i <= totalPages; i++) {
                // 將每個 LI 元素的 onclick 事件改為使用匿名函式
                paginationHTML += `<li class="page-item"><a class="page-link" href="javascript:void(0);" onclick="handlePageClick(${i})">${i}</a></li>`;
            }
            paginationContainer.innerHTML = `<ul class="pagination" style="margin: 0;">${paginationHTML}</ul>`;


        });

    </script>

}


@section Scriptshead{
    <script>
        var currentSortType = ""; 
        // 定義處理分頁點擊的函式

        function handlePageClick(pageNumber) {

            var products = @Html.Raw(Json.Encode(Model));

            if (currentSortType === "hot") {
                products.sort(function (a, b) {
                    return b.QuantitySold - a.QuantitySold; //由高到低排序
                });
            } else if (currentSortType === "price_high") {
                products.sort(function (a, b) {
                    return b.Price - a.Price; //由高到低排序
                });
            } else if (currentSortType === "price_low") {
                products.sort(function (a, b) {
                    return a.Price - b.Price; //由低到高排序
                });
            } else if (currentSortType == null) {
                products = @Html.Raw(Json.Encode(Model));
            }

        showPage(pageNumber, products);
        }


        function showPage(pageNumber, sortedProducts) {

                var pageSize = 20;
                var startIndex = (pageNumber - 1) * pageSize;
                var endIndex = startIndex + pageSize;
                var currentPageProducts = sortedProducts.slice(startIndex, endIndex);

                var productContainer = document.getElementById("productContainer");
                var productHTML = "";

                currentPageProducts.forEach(function (item) {
                    productHTML += `
                <div class="col">
                    <div class="card w-100">
                        <img src="/img/${item.ProductImagePathOne}" class="card-img-top px-4 pt-4" alt="...">
                        <div class="card-body">
                            <p class="card-title">${item.ProductName}</p>
                            <span class="card-text text-danger fw-bold">NT$${Math.round(item.Price).toLocaleString()}</span>
                            <p style="font-size: 8px;" class="card-text mb-1">已售出：${item.QuantitySold}</p>
                            <a href="@Url.Action("UserSingleProduct", "UserProduct")?productid=${item.ProductId}" class="btn btn-secondary">了解更多...</a>
                        </div>
                    </div>
                </div>
                `;
                });

                productContainer.innerHTML = productHTML;
            }
    </script>

}