@model prjEShopping.Controllers.CouponsController.PaginatedViewModel<prjEShopping.Models.ViewModels.CouponVM>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutAdminelse.cshtml";
}

<div class="col-10 bg-secondary overflow-auto pt-4">
    <h2 class="text-primary">優惠券列表</h2>
    <div id="dataContainer">
        <div class="container overflow-auto">
            <p>
                @Html.ActionLink("新增優惠券", "Create", null, new { @class = "btn btn-primary my-2" })
            </p>


            @*優惠券圖片版本*@
            <table class="table table-primary table-bordered " style="width:1300px" id="myTable">
                <thead>
                    <tr>
                        <td style="width:100px">票券設定</td>
                        <td style="width:100px">券號</td>
                        <td style="width:320px">優惠券</td>
                        <td style="width:100px">使用條件</td>
                        <td style="width:100px">數量</td>
                        <td style="width:130px">領取期限</td>
                        <td style="width:380px">說明</td>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Items)
                    {
                        <tr>
                            <td>
                                @Html.ActionLink("修改", "Edit", new { id = item.CouponId }, new { @class = "btn btn-secondary my-1" })
                                @*用不到刪除功能還在*@
                                @*@Html.ActionLink("刪除", "Delete", new { id = item.CouponId }, new { @class = "btn btn-danger my-1" })*@
                            </td>
                            <td>@Html.DisplayFor(modelItem => item.CouponNumber)</td>
                            <td>
                                <div class="d-flex me-2 coupon-item mb-2">
                                    <img src="~/img/coupon.png" alt="">
                                    <div class="d-flex flex-column p-2 bg-info">
                                        <span>@Html.DisplayFor(modelItem => item.CouponName) @Html.DisplayFor(modelItem => item.CouponType) </span>
                                        <span>
                                            @Html.DisplayFor(modelItem => item.Storewide)
                                            @if (item.CouponType == "折價券")
                                            {
                                                <text>@Html.DisplayFor(modelItem => item.Discount)折</text>
                                            }
                                            else if (item.CouponType == "抵用券")
                                            {
                                                <text>@Html.DisplayFor(modelItem => item.Discount)元</text>
                                            }
                                            else if (item.CouponType == "免運券")
                                            {
                                                <text>免運</text>
                                            }
                                        </span>
                                        @*<span>使用期限 @Html.DisplayFor(modelItem => item.StartTime)</span>*@
                                        <span>期限:  @Html.DisplayFor(modelItem => item.EndTime)</span>
                                        <div class="d-flex">
                                            <a href="#">查看賣場<i class="fa-solid fa-caret-right"></i></a>
                                            <button type="button" class="btn btn-secondary ms-3">領取</button>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>@Html.DisplayFor(modelItem => item.CouponTerms)</td>
                            <td>@Html.DisplayFor(modelItem => item.Quantity) </td>
                            <td>@Html.DisplayFor(modelItem => item.ClaimDeadline)</td>
                            <td class="text-wrap">@Html.DisplayFor(modelItem => item.CouponDetails)</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
@section Scripts{

    <!-- DataTables JavaScript -->
    @*<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>*@
    <!-- DataTables BS5版本-->
    <script src="https://cdn.datatables.net/v/bs5/dt-1.13.6/datatables.min.js"></script>

    <script>
        // 定義一個新的排序方法重要 不然金額排序會錯
        $.fn.dataTable.ext.type.order['currency-pre'] = function (data) {
            // 移除不需要的字符，例如 NT$ 和逗號，然後將其轉換為浮點數
            return parseFloat(data.replace('NT$', '').replace(',', ''));
        };
        $(document).ready(function () {
            $('#myTable').DataTable({
                pageLength: 10, // 每頁顯示10筆資料
                columnDefs: [{
                    type: 'currency', // 使用上面定義的排序方法
                    targets: [3]  // 替換 [0] 為你希望套用這種排序的柱子索引值。例如：0，如果你希望在第一列上使用這個排序。
                }],
                language: {
                    search: "搜尋：",
                    paginate: {
                        first: "首頁",
                        last: "尾頁",
                        next: "下一頁",
                        previous: "上一頁"
                    },
                    info: "顯示 _START_ 到 _END_ 的 _TOTAL_ 筆資料",
                    //最下面顯示
                    infoEmpty: "顯示 0 到 0 的 0 筆資料",
                    //下拉選單
                    lengthMenu: "顯示 _MENU_ 筆資料",
                }
            });
        });

        $(document).ready(function () {
            $('.change-status-btn').click(function () {
                var newStatusId = $(this).data('status');
                var productId = $(this).data('product-id');
                // AJAX call to server
                $.ajax({
                    url: '/AdminProducts/ChangeStatus',
                    type: 'POST',
                    data: { id: productId, statusId: newStatusId },
                    success: function (response) {
                        let r = ""
                        if (response.newStatusId == "1")
                            r = "審核中"
                        else if (response.newStatusId == "2")
                            r = "販售中"
                        else if (response.newStatusId == "3")
                            r = "下架中"

                        var statusColor;
                        switch (r) {
                            case "審核中":
                                statusColor = "text-white bg-danger";
                                break;
                            case "販售中":
                                statusColor = "text-white bg-primary";
                                break;
                            case "下架中":
                                statusColor = "text-primary bg-secondary";
                                break;
                            default:
                                statusColor = "";  // 或任何你希望的默認樣式
                                break;
                        }
                        // Update the displayed status
                        $('tr').find('.statusDisplay[data-product-id="' + productId + '"]').text(r).attr('class', 'statusDisplay ' + statusColor);
                    },
                    error: function (error) {
                        console.log("Error:", error);
                    }
                });
            });
        });
    </script>

}

@section Styles{

    <!-- DataTables CSS -->
    @*<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">*@
    <!-- DataTables CSS BS5版本 -->
    <link href="https://cdn.datatables.net/v/bs5/dt-1.13.6/datatables.min.css" rel="stylesheet">

}
